<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Azure Voice AI Assistant - Enterprise</title>
    <style>
        :root {
            --primary-blue: #0066cc;
            --primary-dark: #004080;
            --secondary-blue: #e6f3ff;
            --accent-green: #00b050;
            --accent-red: #d13438;
            --accent-orange: #ff8c00;
            --neutral-100: #f8f9fa;
            --neutral-200: #e9ecef;
            --neutral-300: #dee2e6;
            --neutral-400: #ced4da;
            --neutral-500: #6c757d;
            --neutral-700: #495057;
            --neutral-800: #343a40;
            --neutral-900: #212529;
            --shadow-light: 0 2px 4px rgba(0,0,0,0.1);
            --shadow-medium: 0 4px 12px rgba(0,0,0,0.15);
            --shadow-heavy: 0 8px 32px rgba(0,0,0,0.2);
            --border-radius: 8px;
            --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            color: var(--neutral-800);
            line-height: 1.6;
        }

        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
            height: 100vh;
        }

        .main-panel {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-medium);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .header-left p {
            font-size: 14px;
            opacity: 0.9;
            font-weight: 400;
        }

        .status-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-badge.connected {
            background: rgba(0, 176, 80, 0.2);
            color: var(--accent-green);
        }

        .status-badge.connecting {
            background: rgba(255, 140, 0, 0.2);
            color: var(--accent-orange);
        }

        .status-badge.disconnected {
            background: rgba(209, 52, 56, 0.2);
            color: var(--accent-red);
        }

        .conversation-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .conversation-state {
            padding: 16px 24px;
            background: var(--neutral-100);
            border-bottom: 1px solid var(--neutral-300);
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
            font-weight: 500;
        }

        .state-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--neutral-400);
            transition: var(--transition);
        }

        .state-indicator.listening {
            background: var(--accent-green);
            box-shadow: 0 0 0 4px rgba(0, 176, 80, 0.2);
            animation: pulse 2s infinite;
        }

        .state-indicator.processing {
            background: var(--accent-orange);
            animation: spin 1s linear infinite;
        }

        .state-indicator.speaking {
            background: var(--primary-blue);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .vad-monitor {
            padding: 12px 24px;
            background: white;
            border-bottom: 1px solid var(--neutral-300);
        }

        .vad-level-container {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 12px;
            color: var(--neutral-500);
        }

        .vad-level-bar {
            flex: 1;
            height: 4px;
            background: var(--neutral-300);
            border-radius: 2px;
            overflow: hidden;
        }

        .vad-level-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-green) 0%, var(--accent-orange) 70%, var(--accent-red) 100%);
            width: 0%;
            transition: width 0.1s ease;
        }

        .chat-area {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            background: var(--neutral-100);
        }

        .message {
            margin-bottom: 20px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            opacity: 0;
            animation: slideIn 0.3s ease forwards;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: 500;
            flex-shrink: 0;
        }

        .message.user .message-avatar {
            background: var(--primary-blue);
            color: white;
        }

        .message.agent .message-avatar {
            background: var(--accent-green);
            color: white;
        }

        .message.system .message-avatar {
            background: var(--neutral-400);
            color: white;
        }

        .message-content {
            max-width: 70%;
            padding: 16px 20px;
            border-radius: 16px;
            font-size: 14px;
            line-height: 1.5;
            box-shadow: var(--shadow-light);
            position: relative;
        }

        .message.user .message-content {
            background: var(--primary-blue);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.agent .message-content {
            background: white;
            color: var(--neutral-800);
            border: 1px solid var(--neutral-300);
            border-bottom-left-radius: 4px;
        }

        .message.system .message-content {
            background: var(--secondary-blue);
            color: var(--primary-dark);
            border-bottom-left-radius: 4px;
            font-size: 13px;
            font-style: italic;
        }

        .message-time {
            font-size: 11px;
            color: rgba(255,255,255,0.7);
            margin-top: 8px;
        }

        .message.agent .message-time,
        .message.system .message-time {
            color: var(--neutral-500);
        }

        .controls-area {
            padding: 24px;
            background: white;
            border-top: 1px solid var(--neutral-300);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: var(--border-radius);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            min-height: 44px;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn.primary {
            background: var(--primary-blue);
            color: white;
        }

        .btn.primary:hover:not(:disabled) {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow-medium);
        }

        .btn.danger {
            background: var(--accent-red);
            color: white;
        }

        .btn.danger:hover:not(:disabled) {
            background: #b71c1c;
            transform: translateY(-1px);
            box-shadow: var(--shadow-medium);
        }

        .btn.secondary {
            background: var(--neutral-200);
            color: var(--neutral-700);
        }

        .btn.secondary:hover:not(:disabled) {
            background: var(--neutral-300);
            transform: translateY(-1px);
        }

        .mic-button {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: var(--neutral-400);
            color: white;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .mic-button.active {
            background: var(--accent-green);
            animation: pulse 2s infinite;
        }

        .mic-button.speaking {
            background: var(--accent-red);
            animation: pulse 1s infinite;
        }

        .side-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .panel-card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-medium);
            overflow: hidden;
        }

        .panel-header {
            padding: 16px 20px;
            background: var(--neutral-100);
            border-bottom: 1px solid var(--neutral-300);
            font-weight: 600;
            font-size: 14px;
            color: var(--neutral-700);
        }

        .panel-content {
            padding: 20px;
        }

        .metric-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 20px;
        }

        .metric {
            text-align: center;
            padding: 16px;
            background: var(--neutral-100);
            border-radius: var(--border-radius);
        }

        .metric-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-blue);
            display: block;
        }

        .metric-label {
            font-size: 12px;
            color: var(--neutral-500);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .setting-group {
            margin-bottom: 20px;
        }

        .setting-label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: var(--neutral-700);
            margin-bottom: 8px;
        }

        .setting-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--neutral-300);
            border-radius: var(--border-radius);
            font-size: 14px;
            transition: var(--transition);
        }

        .setting-input:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
        }

        .range-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .range-input {
            flex: 1;
            height: 4px;
            border-radius: 2px;
            background: var(--neutral-300);
            outline: none;
            -webkit-appearance: none;
        }

        .range-input::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--primary-blue);
            cursor: pointer;
            box-shadow: var(--shadow-light);
        }

        .range-value {
            font-size: 12px;
            font-weight: 500;
            color: var(--neutral-600);
            min-width: 40px;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--neutral-300);
            transition: var(--transition);
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background: white;
            transition: var(--transition);
            border-radius: 50%;
            box-shadow: var(--shadow-light);
        }

        input:checked + .toggle-slider {
            background: var(--primary-blue);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        .performance-metrics {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
        }

        .performance-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: var(--neutral-100);
            border-radius: var(--border-radius);
            font-size: 13px;
        }

        .performance-label {
            color: var(--neutral-600);
        }

        .performance-value {
            font-weight: 600;
            color: var(--neutral-800);
        }

        .performance-value.good {
            color: var(--accent-green);
        }

        .performance-value.warning {
            color: var(--accent-orange);
        }

        .performance-value.error {
            color: var(--accent-red);
        }

        .footer-info {
            padding: 16px 20px;
            background: var(--neutral-100);
            border-top: 1px solid var(--neutral-300);
            font-size: 12px;
            color: var(--neutral-500);
            text-align: center;
        }

        .loading-indicator {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--neutral-300);
            border-radius: 50%;
            border-top-color: var(--primary-blue);
            animation: spin 1s ease-in-out infinite;
        }

        @media (max-width: 1200px) {
            .app-container {
                grid-template-columns: 1fr;
                grid-template-rows: 1fr auto;
            }
            
            .side-panel {
                flex-direction: row;
                overflow-x: auto;
            }
            
            .panel-card {
                min-width: 300px;
            }
        }

        @media (max-width: 768px) {
            .app-container {
                padding: 10px;
                gap: 10px;
            }
            
            .header {
                padding: 16px;
            }
            
            .header-left h1 {
                font-size: 20px;
            }
            
            .side-panel {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="main-panel">
            <div class="header">
                <div class="header-left">
                    <h1>Azure Voice AI Assistant</h1>
                    <p>Enterprise-grade conversational AI with real-time voice interaction</p>
                </div>
                <div class="status-badge disconnected" id="statusBadge">
                    <span class="loading-indicator" style="display: none;" id="loadingIndicator"></span>
                    <span id="statusText">Disconnected</span>
                </div>
            </div>

            <div class="conversation-area">
                <div class="conversation-state">
                    <div class="state-indicator" id="stateIndicator"></div>
                    <span id="conversationState">Ready to connect</span>
                    <div style="margin-left: auto; font-size: 12px; color: var(--neutral-500);">
                        <span id="responseTime">0ms</span>
                    </div>
                </div>

                <div class="vad-monitor">
                    <div class="vad-level-container">
                        <span>Voice Level:</span>
                        <div class="vad-level-bar">
                            <div class="vad-level-fill" id="vadLevelFill"></div>
                        </div>
                        <span id="vadPercentage">0%</span>
                    </div>
                </div>

                <div class="chat-area" id="chatArea">
                    <div class="message system">
                        <div class="message-avatar">ℹ️</div>
                        <div class="message-content">
                            Welcome to Azure Voice AI Assistant. Click "Start Session" to begin real-time voice conversation with enterprise-grade AI.
                            <div class="message-time" id="welcomeTime"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="controls-area">
                <button class="btn primary" id="startBtn" onclick="startSession()">
                    🚀 Start Session
                </button>
                <button class="btn mic-button" id="micBtn" onclick="toggleVAD()" disabled>
                    🎤
                </button>
                <button class="btn secondary" id="stopBtn" onclick="stopAgent()" disabled>
                    ⏹️ Stop
                </button>
                <button class="btn danger" id="endBtn" onclick="endSession()" disabled>
                    🛑 End Session
                </button>
            </div>
        </div>

        <div class="side-panel">
            <div class="panel-card">
                <div class="panel-header">Session Metrics</div>
                <div class="panel-content">
                    <div class="metric-grid">
                        <div class="metric">
                            <span class="metric-value" id="messageCount">0</span>
                            <span class="metric-label">Messages</span>
                        </div>
                        <div class="metric">
                            <span class="metric-value" id="sessionDuration">0:00</span>
                            <span class="metric-label">Duration</span>
                        </div>
                    </div>
                    <div class="performance-metrics">
                        <div class="performance-item">
                            <span class="performance-label">Avg Response Time</span>
                            <span class="performance-value good" id="avgResponseTime">0ms</span>
                        </div>
                        <div class="performance-item">
                            <span class="performance-label">Speech Recognition</span>
                            <span class="performance-value good" id="speechStatus">Ready</span>
                        </div>
                        <div class="performance-item">
                            <span class="performance-label">Azure TTS</span>
                            <span class="performance-value good" id="ttsStatus">Ready</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="panel-card">
                <div class="panel-header">Voice Settings</div>
                <div class="panel-content">
                    <div class="setting-group">
                        <label class="setting-label">Neural Voice</label>
                        <select class="setting-input" id="voiceSelect" onchange="updateVoice()">
                            <option value="en-US-JennyNeural">Jenny (US Female) - Neural</option>
                            <option value="en-US-GuyNeural">Guy (US Male) - Neural</option>
                            <option value="en-US-AriaNeural">Aria (US Female) - Neural</option>
                            <option value="en-US-DavisNeural">Davis (US Male) - Neural</option>
                            <option value="en-GB-SoniaNeural">Sonia (UK Female) - Neural</option>
                            <option value="en-GB-RyanNeural">Ryan (UK Male) - Neural</option>
                        </select>
                    </div>

                    <div class="setting-group">
                        <label class="setting-label">Voice Sensitivity</label>
                        <div class="range-container">
                            <input type="range" class="range-input" id="vadSensitivity" 
                                   min="0.1" max="0.9" value="0.3" step="0.05">
                            <span class="range-value" id="vadSensitivityValue">30%</span>
                        </div>
                    </div>

                    <div class="setting-group">
                        <label class="setting-label">Silence Timeout</label>
                        <div class="range-container">
                            <input type="range" class="range-input" id="silenceTimeout" 
                                   min="0.5" max="3" value="1.5" step="0.1">
                            <span class="range-value" id="silenceValue">1.5s</span>
                        </div>
                    </div>

                    <div class="setting-group">
                        <label class="setting-label">Auto-speak Responses</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="autoSpeak" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <div class="setting-group">
                        <label class="setting-label">Real-time Mode</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="realTimeMode" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="panel-card">
                <div class="panel-header">Advanced Settings</div>
                <div class="panel-content">
                    <div class="setting-group">
                        <label class="setting-label">Backend URL</label>
                        <input type="text" class="setting-input" id="backendUrl" 
                               value="http://127.0.0.1:5000" onchange="updateBackendUrl()">
                    </div>

                    <div class="setting-group">
                        <button class="btn secondary" onclick="testVoice()" style="width: 100%;">
                            🎤 Test Voice Synthesis
                        </button>
                    </div>

                    <div class="setting-group">
                        <button class="btn secondary" onclick="optimizeSettings()" style="width: 100%;">
                            ⚡ Optimize Performance
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // === PERFORMANCE OPTIMIZATION CONSTANTS ===
        const PERFORMANCE_CONFIG = {
            FAST_RESPONSE_MODE: true,
            VAD_CHECK_INTERVAL: 50, // 50ms for faster detection
            SILENCE_TIMEOUT_FAST: 1000, // 1 second
            MAX_AGENT_WAIT_TIME: 15, // 15 seconds max
            TTS_TIMEOUT: 10000, // 10 second TTS timeout
            SPEECH_RECOGNITION_TIMEOUT: 8000, // 8 second timeout
            CONCURRENT_PROCESSING: true
        };

        // === APPLICATION STATE ===
        let isConnected = false;
        let currentSessionId = null;
        let currentThreadId = null;
        let messageCount = 0;
        let sessionStartTime = null;
        let backendUrl = 'http://127.0.0.1:5000';
        
        // === PERFORMANCE TRACKING ===
        let responseTimes = [];
        let lastRequestTime = null;
        
        // === CONVERSATION STATE MACHINE ===
        const ConversationState = {
            IDLE: 'idle',
            LISTENING: 'listening', 
            PROCESSING: 'processing',
            SPEAKING: 'speaking'
        };
        
        let currentState = ConversationState.IDLE;
        
        // === OPTIMIZED VAD AND AUDIO STATE ===
        let audioContext = null;
        let mediaStream = null;
        let analyser = null;
        let vadActive = false;
        let vadLevel = 0;
        let vadTimer = null;
        let speechDetected = false;
        let lastSpeechTime = 0;
        let vadCheckInterval = null;
        
        // === OPTIMIZED SPEECH RECOGNITION ===
        let recognition = null;
        let currentAudio = null;
        let speechBuffer = '';
        let silenceTimer = null;
        let recognitionTimeout = null;
        
        // === AUDIO MANAGEMENT ===
        let currentAudioController = null;
        let audioQueue = [];
        let isAudioPlaying = false;
        
        // === INITIALIZATION ===
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            setupEventListeners();
            updateWelcomeTime();
        });
        
        function initializeApp() {
            console.log('🚀 Initializing Optimized Voice Agent');
            updateConversationState(ConversationState.IDLE);
            updateBackendUrl();
            initializeSpeechRecognition();
            startPerformanceMonitoring();
            
            // Apply performance optimizations
            if (PERFORMANCE_CONFIG.FAST_RESPONSE_MODE) {
                document.getElementById('silenceTimeout').value = '1.0';
                document.getElementById('silenceValue').textContent = '1.0s';
                document.getElementById('vadSensitivity').value = '0.25';
                document.getElementById('vadSensitivityValue').textContent = '25%';
            }
        }
        
        function setupEventListeners() {
            // Optimized event listeners
            document.getElementById('backendUrl').addEventListener('change', updateBackendUrl);
            
            // VAD sensitivity with debouncing
            let sensitivityTimeout;
            document.getElementById('vadSensitivity').addEventListener('input', function() {
                clearTimeout(sensitivityTimeout);
                sensitivityTimeout = setTimeout(() => {
                    document.getElementById('vadSensitivityValue').textContent = Math.round(this.value * 100) + '%';
                }, 100);
            });
            
            // Silence timeout with debouncing
            let silenceTimeoutDebounce;
            document.getElementById('silenceTimeout').addEventListener('input', function() {
                clearTimeout(silenceTimeoutDebounce);
                silenceTimeoutDebounce = setTimeout(() => {
                    document.getElementById('silenceValue').textContent = this.value + 's';
                }, 100);
            });
            
            // Real-time mode toggle
            document.getElementById('realTimeMode').addEventListener('change', function() {
                if (this.checked && vadActive) {
                    startNaturalConversation();
                } else {
                    stopNaturalConversation();
                }
            });
        }
        
        // === OPTIMIZED VOICE ACTIVITY DETECTION ===
        async function initializeVAD() {
            try {
                console.log('🎤 Initializing Optimized VAD...');
                
                mediaStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true,
                        sampleRate: 16000,
                        latency: 0.01 // Low latency
                    }
                });
                
                audioContext = new (window.AudioContext || window.webkitAudioContext)({
                    latencyHint: 'interactive',
                    sampleRate: 16000
                });
                
                const source = audioContext.createMediaStreamSource(mediaStream);
                analyser = audioContext.createAnalyser();
                
                // Optimized analyzer settings
                analyser.fftSize = 512; // Faster processing
                analyser.minDecibels = -85;
                analyser.maxDecibels = -10;
                analyser.smoothingTimeConstant = 0.8;
                
                source.connect(analyser);
                
                console.log('✅ Optimized VAD initialized');
                updateSpeechStatus('Ready', 'good');
                return true;
                
            } catch (error) {
                console.error('❌ Failed to initialize VAD:', error);
                addMessage('⚠️ Microphone access denied. Manual mode only.', 'system');
                updateSpeechStatus('Error', 'error');
                return false;
            }
        }
        
        function startVAD() {
            if (!analyser) return false;
            
            vadActive = true;
            updateMicButton();
            startOptimizedVADMonitoring();
            console.log('🔴 Optimized VAD monitoring started');
            return true;
        }
        
        function stopVAD() {
            vadActive = false;
            if (vadCheckInterval) {
                clearInterval(vadCheckInterval);
                vadCheckInterval = null;
            }
            updateMicButton();
            updateVADIndicator(0);
            console.log('⏹️ VAD monitoring stopped');
        }
        
        function startOptimizedVADMonitoring() {
            if (!vadActive || !analyser) return;
            
            // Use setInterval for consistent timing instead of requestAnimationFrame
            vadCheckInterval = setInterval(() => {
                if (!vadActive || !analyser) return;
                
                const bufferLength = analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);
                analyser.getByteFrequencyData(dataArray);
                
                // Optimized audio level calculation
                let sum = 0;
                for (let i = 0; i < bufferLength; i++) {
                    sum += dataArray[i];
                }
                const average = sum / bufferLength;
                const normalizedLevel = Math.min(average / 45, 1); // Optimized threshold
                
                vadLevel = normalizedLevel;
                updateVADIndicator(vadLevel);
                
                // Voice activity detection
                const sensitivity = parseFloat(document.getElementById('vadSensitivity').value);
                const isVoiceDetected = normalizedLevel > sensitivity;
                
                if (isVoiceDetected) {
                    lastSpeechTime = Date.now();
                    
                    // Handle interruption during agent speaking
                    if (currentState === ConversationState.SPEAKING) {
                        console.log('🛑 Voice detected during agent speech - interrupting');
                        handleInterruption();
                    }
                    // Start listening if ready and not already processing
                    else if (currentState === ConversationState.LISTENING && !speechDetected) {
                        speechDetected = true;
                        startOptimizedSpeechRecognition();
                    }
                }
                
                // Optimized silence detection
                const silenceTimeout = parseFloat(document.getElementById('silenceTimeout').value) * 1000;
                if (speechDetected && (Date.now() - lastSpeechTime) > silenceTimeout) {
                    handleSpeechEnd();
                }
                
            }, PERFORMANCE_CONFIG.VAD_CHECK_INTERVAL);
        }
        
        function handleInterruption() {
            forceStopAllAudio();
            updateConversationState(ConversationState.LISTENING);
            speechDetected = false;
            console.log('✅ Interruption handled - ready for new input');
        }
        
        function handleSpeechEnd() {
            if (recognition && speechBuffer.trim()) {
                console.log('🗣️ Processing speech:', speechBuffer.trim());
                processSpeech(speechBuffer.trim());
            }
            
            speechDetected = false;
            speechBuffer = '';
            
            if (recognition) {
                recognition.stop();
            }
            
            if (recognitionTimeout) {
                clearTimeout(recognitionTimeout);
                recognitionTimeout = null;
            }
        }
        
        // === OPTIMIZED SPEECH RECOGNITION ===
        function initializeSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                
                // Optimized settings for speed
                recognition.continuous = false;
                recognition.interimResults = true;
                recognition.lang = 'en-US';
                recognition.maxAlternatives = 1;
                
                recognition.onstart = function() {
                    console.log('🎤 Fast speech recognition started');
                    updateSpeechStatus('Listening', 'good');
                };
                
                recognition.onresult = function(event) {
                    let finalTranscript = '';
                    
                    for (let i = 0; i < event.results.length; i++) {
                        if (event.results[i].isFinal) {
                            finalTranscript += event.results[i][0].transcript;
                        }
                    }
                    
                    if (finalTranscript) {
                        speechBuffer = finalTranscript.trim();
                        // Immediate processing for faster response
                        if (PERFORMANCE_CONFIG.FAST_RESPONSE_MODE && speechBuffer.length > 2) {
                            handleSpeechEnd();
                        }
                    }
                };
                
                recognition.onerror = function(event) {
                    console.log('⚠️ Speech recognition error:', event.error);
                    updateSpeechStatus('Error', 'warning');
                    speechDetected = false;
                };
                
                recognition.onend = function() {
                    console.log('🔚 Speech recognition ended');
                    updateSpeechStatus('Ready', 'good');
                };
                
                console.log('✅ Optimized speech recognition initialized');
            } else {
                console.error('❌ Speech recognition not supported');
                addMessage('⚠️ Speech recognition not supported in this browser', 'system');
                updateSpeechStatus('Not Supported', 'error');
            }
        }
        
        function startOptimizedSpeechRecognition() {
            if (recognition && currentState === ConversationState.LISTENING) {
                try {
                    recognition.start();
                    
                    // Set timeout for speech recognition
                    recognitionTimeout = setTimeout(() => {
                        if (recognition && speechDetected) {
                            console.log('⏰ Speech recognition timeout - processing what we have');
                            handleSpeechEnd();
                        }
                    }, PERFORMANCE_CONFIG.SPEECH_RECOGNITION_TIMEOUT);
                    
                } catch (error) {
                    console.log('Speech recognition start error:', error);
                    speechDetected = false;
                }
            }
        }
        
        function processSpeech(transcript) {
            if (!transcript || transcript.length < 2) return;
            
            addMessage(transcript, 'user');
            sendToAgent(transcript);
        }
        
        // === OPTIMIZED CONVERSATION STATE MANAGEMENT ===
        function updateConversationState(newState) {
            currentState = newState;
            
            const stateIndicator = document.getElementById('stateIndicator');
            const stateText = document.getElementById('conversationState');
            
            stateIndicator.className = 'state-indicator';
            
            switch (newState) {
                case ConversationState.IDLE:
                    stateText.textContent = 'Ready to connect';
                    break;
                case ConversationState.LISTENING:
                    stateIndicator.classList.add('listening');
                    stateText.textContent = 'Listening for voice input...';
                    break;
                case ConversationState.PROCESSING:
                    stateIndicator.classList.add('processing');
                    stateText.textContent = 'Processing your message...';
                    break;
                case ConversationState.SPEAKING:
                    stateIndicator.classList.add('speaking');
                    stateText.textContent = 'AI is speaking...';
                    break;
            }
            
            console.log(`🔄 State: ${newState}`);
        }
        
        // === OPTIMIZED SESSION MANAGEMENT ===
        async function startSession() {
            try {
                updateStatus('Connecting...', 'connecting', true);
                const startTime = Date.now();
                
                const result = await apiCall('start_session', 'POST', {});
                
                if (result.success) {
                    currentSessionId = result.session_id;
                    currentThreadId = result.thread_id;
                    messageCount = 0;
                    isConnected = true;
                    sessionStartTime = Date.now();
                    
                    enableControls();
                    updateSessionInfo();
                    updateStatus('Connected', 'connected', false);
                    updateConversationState(ConversationState.LISTENING);
                    
                    const responseTime = Date.now() - startTime;
                    addResponseTime(responseTime);
                    
                    addMessage('Hello! I\'m your optimized Azure AI assistant. How can I help you today?', 'agent');
                    addMessage(`Session started! Thread: ${currentThreadId.substring(0, 8)}...`, 'system');
                    
                    // Auto-start real-time conversation
                    if (document.getElementById('realTimeMode').checked) {
                        setTimeout(() => startNaturalConversation(), 500);
                    }
                } else {
                    throw new Error(result.error || 'Failed to start session');
                }
                
            } catch (error) {
                updateStatus(`Connection failed: ${error.message}`, 'disconnected', false);
                console.error('Session start error:', error);
            }
        }
        
        async function endSession() {
            try {
                updateStatus('Ending session...', 'connecting', true);
                
                stopNaturalConversation();
                forceStopAllAudio();
                
                if (currentSessionId) {
                    await apiCall('end_session', 'POST', { session_id: currentSessionId });
                }
                
                // Reset state
                currentSessionId = null;
                currentThreadId = null;
                messageCount = 0;
                isConnected = false;
                sessionStartTime = null;
                responseTimes = [];
                
                updateSessionInfo();
                disableControls();
                updateStatus('Disconnected', 'disconnected', false);
                updateConversationState(ConversationState.IDLE);
                
                addMessage('Session ended. Click "Start Session" to begin a new conversation.', 'system');
                
                // Clean up resources
                if (mediaStream) {
                    mediaStream.getTracks().forEach(track => track.stop());
                    mediaStream = null;
                }
                if (audioContext && audioContext.state !== 'closed') {
                    audioContext.close();
                    audioContext = null;
                }
                
            } catch (error) {
                console.error('End session error:', error);
                updateStatus('Error ending session', 'disconnected', false);
            }
        }
        
        // === OPTIMIZED AGENT COMMUNICATION ===
        async function sendToAgent(message) {
            try {
                forceStopAllAudio();
                updateConversationState(ConversationState.PROCESSING);
                
                const startTime = Date.now();
                lastRequestTime = startTime;
                
                const result = await Promise.race([
                    apiCall('send_message', 'POST', {
                        session_id: currentSessionId,
                        message: message
                    }),
                    new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Request timeout')), 
                        PERFORMANCE_CONFIG.MAX_AGENT_WAIT_TIME * 1000)
                    )
                ]);
                
                const responseTime = Date.now() - startTime;
                addResponseTime(responseTime);
                
                if (result.success) {
                    addMessage(result.response, 'agent');
                    messageCount = result.message_count || messageCount + 1;
                    updateSessionInfo();
                    
                    // Optimized TTS with concurrent processing
                    if (document.getElementById('autoSpeak').checked) {
                        speakText(result.response);
                    } else {
                        updateConversationState(ConversationState.LISTENING);
                    }
                    
                    if (result.should_end_session) {
                        setTimeout(() => endSession(), 2000);
                        return;
                    }
                    
                } else {
                    throw new Error(result.error || 'Failed to send message');
                }
                
            } catch (error) {
                updateStatus(`Error: ${error.message}`, 'disconnected', false);
                console.error('Send message error:', error);
                addMessage(`Error: ${error.message}`, 'system');
                updateConversationState(ConversationState.LISTENING);
            }
        }
        
        // === OPTIMIZED TEXT-TO-SPEECH ===
        async function speakText(text) {
            if (!document.getElementById('autoSpeak').checked) return;
            
            updateConversationState(ConversationState.SPEAKING);
            updateTTSStatus('Generating', 'warning');
            
            try {
                await speakWithAzure(text);
            } catch (error) {
                console.error('TTS Error:', error);
                updateTTSStatus('Error', 'error');
                updateConversationState(ConversationState.LISTENING);
            }
        }
        
        async function speakWithAzure(text) {
            try {
                const voiceName = document.getElementById('voiceSelect').value;
                currentAudioController = new AbortController();
                
                const startTime = Date.now();
                
                const response = await Promise.race([
                    fetch(`${backendUrl}/api/synthesize_speech`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            text: text,
                            voice_name: voiceName,
                            session_id: currentSessionId
                        }),
                        signal: currentAudioController.signal
                    }),
                    new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('TTS timeout')), 
                        PERFORMANCE_CONFIG.TTS_TIMEOUT)
                    )
                ]);
                
                if (currentAudioController.signal.aborted) {
                    console.log('🛑 TTS request aborted');
                    return;
                }
                
                if (!response.ok) {
                    throw new Error(`TTS failed: ${response.status}`);
                }
                
                const audioBlob = await response.blob();
                const ttsTime = Date.now() - startTime;
                console.log(`🔊 TTS generated in ${ttsTime}ms`);
                
                updateTTSStatus('Playing', 'good');
                await playAudioBlob(audioBlob, voiceName);
                
            } catch (error) {
                if (error.name !== 'AbortError') {
                    console.error('❌ Azure TTS error:', error);
                    updateTTSStatus('Error', 'error');
                    throw error;
                }
            }
        }
        
        async function playAudioBlob(audioBlob, voiceName) {
            return new Promise((resolve, reject) => {
                if (currentAudioController?.signal.aborted) {
                    resolve();
                    return;
                }
                
                const audioUrl = URL.createObjectURL(audioBlob);
                const audio = new Audio(audioUrl);
                
                audio.oncanplaythrough = () => {
                    if (!currentAudioController?.signal.aborted) {
                        audio.play().catch(reject);
                    }
                };
                
                audio.onended = () => {
                    console.log('🔊 Audio playback completed');
                    URL.revokeObjectURL(audioUrl);
                    
                    if (!currentAudioController?.signal.aborted) {
                        updateConversationState(ConversationState.LISTENING);
                        updateTTSStatus('Ready', 'good');
                    }
                    currentAudio = null;
                    currentAudioController = null;
                    resolve();
                };
                
                audio.onerror = (error) => {
                    URL.revokeObjectURL(audioUrl);
                    currentAudio = null;
                    currentAudioController = null;
                    reject(error);
                };
                
                if (currentAudioController) {
                    currentAudioController.signal.addEventListener('abort', () => {
                        audio.pause();
                        audio.currentTime = 0;
                        URL.revokeObjectURL(audioUrl);
                        currentAudio = null;
                        resolve();
                    });
                }
                
                currentAudio = audio;
            });
        }
        
        // === AUDIO MANAGEMENT ===
        function forceStopAllAudio() {
            console.log('🔇 Force stopping all audio...');
            
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
                currentAudio = null;
            }
            
            if (currentAudioController) {
                currentAudioController.abort();
                currentAudioController = null;
            }
            
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
            }
            
            updateTTSStatus('Ready', 'good');
        }
        
        function stopAgent() {
            console.log('🛑 Manually stopping agent...');
            forceStopAllAudio();
            updateConversationState(ConversationState.LISTENING);
        }
        
        // === NATURAL CONVERSATION CONTROL ===
        async function startNaturalConversation() {
            if (!isConnected) {
                addMessage('⚠️ Please start a session first', 'system');
                return;
            }
            
            console.log('🌟 Starting optimized natural conversation...');
            
            if (!audioContext) {
                const vadInitialized = await initializeVAD();
                if (!vadInitialized) {
                    document.getElementById('realTimeMode').checked = false;
                    return;
                }
            }
            
            startVAD();
            updateConversationState(ConversationState.LISTENING);
            addMessage('🎤 Real-time conversation active - speak naturally!', 'system');
        }
        
        function stopNaturalConversation() {
            console.log('⏹️ Stopping natural conversation...');
            stopVAD();
            if (recognition) {
                recognition.stop();
            }
            updateConversationState(ConversationState.IDLE);
        }
        
        async function toggleVAD() {
            if (!vadActive) {
                await startNaturalConversation();
            } else {
                stopNaturalConversation();
            }
        }
        
        // === PERFORMANCE MONITORING ===
        function startPerformanceMonitoring() {
            setInterval(updateSessionDuration, 1000);
            setInterval(updatePerformanceMetrics, 2000);
        }
        
        function addResponseTime(time) {
            responseTimes.push(time);
            if (responseTimes.length > 10) {
                responseTimes.shift();
            }
            
            document.getElementById('responseTime').textContent = `${time}ms`;
            
            const avgTime = responseTimes.reduce((a, b) => a + b, 0) / responseTimes.length;
            document.getElementById('avgResponseTime').textContent = `${Math.round(avgTime)}ms`;
            
            const avgElement = document.getElementById('avgResponseTime');
            avgElement.className = 'performance-value ' + 
                (avgTime < 2000 ? 'good' : avgTime < 5000 ? 'warning' : 'error');
        }
        
        function updateSessionDuration() {
            if (sessionStartTime) {
                const duration = Math.floor((Date.now() - sessionStartTime) / 1000);
                const minutes = Math.floor(duration / 60);
                const seconds = duration % 60;
                document.getElementById('sessionDuration').textContent = 
                    `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }
        }
        
        function updatePerformanceMetrics() {
            // Update message count
            document.getElementById('messageCount').textContent = messageCount;
        }
        
        // === UI HELPER FUNCTIONS ===
        function updateStatus(message, type, loading) {
            const statusBadge = document.getElementById('statusBadge');
            const statusText = document.getElementById('statusText');
            const loadingIndicator = document.getElementById('loadingIndicator');
            
            statusText.textContent = message;
            statusBadge.className = `status-badge ${type}`;
            loadingIndicator.style.display = loading ? 'inline-block' : 'none';
        }
        
        function updateMicButton() {
            const micBtn = document.getElementById('micBtn');
            
            if (vadActive) {
                micBtn.classList.add('active');
                micBtn.title = 'Voice detection active - speak anytime';
            } else {
                micBtn.classList.remove('active');
                micBtn.title = 'Start voice detection';
            }
            
            if (currentState === ConversationState.SPEAKING) {
                micBtn.classList.add('speaking');
            } else {
                micBtn.classList.remove('speaking');
            }
        }
        
        function updateVADIndicator(level) {
            const vadFill = document.getElementById('vadLevelFill');
            const vadPercentage = document.getElementById('vadPercentage');
            
            vadFill.style.width = Math.round(level * 100) + '%';
            vadPercentage.textContent = Math.round(level * 100) + '%';
        }
        
        function updateSpeechStatus(status, type) {
            const element = document.getElementById('speechStatus');
            element.textContent = status;
            element.className = `performance-value ${type}`;
        }
        
        function updateTTSStatus(status, type) {
            const element = document.getElementById('ttsStatus');
            element.textContent = status;
            element.className = `performance-value ${type}`;
        }
        
        function enableControls() {
            document.getElementById('startBtn').disabled = true;
            document.getElementById('micBtn').disabled = false;
            document.getElementById('stopBtn').disabled = false;
            document.getElementById('endBtn').disabled = false;
        }
        
        function disableControls() {
            document.getElementById('startBtn').disabled = false;
            document.getElementById('micBtn').disabled = true;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('endBtn').disabled = true;
            
            stopNaturalConversation();
            forceStopAllAudio();
        }
        
        function updateSessionInfo() {
            // Session info is now handled by the metrics panel
        }
        
        function updateBackendUrl() {
            backendUrl = document.getElementById('backendUrl').value;
            console.log('🔗 Backend URL updated:', backendUrl);
        }
        
        function updateWelcomeTime() {
            const timeString = new Date().toLocaleTimeString('en-US', { 
                hour12: false, hour: '2-digit', minute: '2-digit'
            });
            document.getElementById('welcomeTime').textContent = timeString;
        }
        
        function addMessage(content, type) {
            const chatArea = document.getElementById('chatArea');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            const timeString = new Date().toLocaleTimeString('en-US', { 
                hour12: false, hour: '2-digit', minute: '2-digit'
            });
            
            let avatar = '';
            switch (type) {
                case 'user': avatar = '👤'; break;
                case 'agent': avatar = '🤖'; break;
                case 'system': avatar = 'ℹ️'; break;
            }
            
            messageDiv.innerHTML = `
                <div class="message-avatar">${avatar}</div>
                <div class="message-content">
                    ${content}
                    <div class="message-time">${timeString}</div>
                </div>
            `;
            
            chatArea.appendChild(messageDiv);
            chatArea.scrollTop = chatArea.scrollHeight;
            
            console.log(`💬 Message: [${type}] ${content.substring(0, 50)}...`);
        }
        
        // === UTILITY FUNCTIONS ===
        async function testVoice() {
            const testText = "This is a test of the optimized Azure Neural Voice synthesis. The response should be fast and clear.";
            addMessage('Testing optimized voice synthesis...', 'system');
            await speakWithAzure(testText);
        }
        
        async function updateVoice() {
            if (currentSessionId) {
                try {
                    const voiceName = document.getElementById('voiceSelect').value;
                    await apiCall('set_voice', 'POST', {
                        session_id: currentSessionId,
                        voice_name: voiceName
                    });
                    console.log(`🎤 Voice updated to: ${voiceName}`);
                } catch (error) {
                    console.error('Failed to update voice:', error);
                }
            }
        }
        
        function optimizeSettings() {
            // Apply optimal settings for performance
            document.getElementById('vadSensitivity').value = '0.25';
            document.getElementById('vadSensitivityValue').textContent = '25%';
            document.getElementById('silenceTimeout').value = '1.0';
            document.getElementById('silenceValue').textContent = '1.0s';
            document.getElementById('autoSpeak').checked = true;
            document.getElementById('realTimeMode').checked = true;
            
            addMessage('Performance settings optimized for fastest response times.', 'system');
        }
        
        // === API COMMUNICATION ===
        async function apiCall(endpoint, method, data) {
            try {
                const response = await fetch(`${backendUrl}/api/${endpoint}`, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                return await response.json();
                
            } catch (error) {
                console.error(`API call failed [${endpoint}]:`, error);
                throw error;
            }
        }
    </script>
</body>
</html>